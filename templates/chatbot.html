<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Assistant Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="d-flex align-items-center justify-content-center"> <div class="card shadow-lg chat-container">
        <div class="card-header bg-primary text-white text-center p-3">
            <h1 class="h4 mb-0">
                <i class="fas fa-stethoscope me-2"></i>Medical Assistant Chatbot
            </h1>
        </div>

        <div id="chat-messages" class="card-body p-4">
            <div class="bot-message message-bubble">
                Hello! I'm your medical assistant. How can I help you today? Please describe your symptoms or ask a medical question.
            </div>
            </div>

        <div id="typing-indicator-container" style="display: none;">
            <div class="bot-message message-bubble py-2 px-3 d-inline-block">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <div class="card-footer">
            <form id="message-form" class="d-flex">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message..."
                    class="form-control form-control-lg me-2"
                    autocomplete="off"
                >
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const typingIndicatorContainer = document.getElementById('typing-indicator-container');

        // Function to add a message to the chat
        function addMessage(message, sender) {
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');
            // Sanitize message content to prevent XSS
            bubbleDiv.textContent = message;

            if (sender === 'user') {
                bubbleDiv.classList.add('user-message');
            } else {
                bubbleDiv.classList.add('bot-message');
            }
            chatMessages.appendChild(bubbleDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
        }

        // Function to show/hide typing indicator
        function showTypingIndicator(show) {
            typingIndicatorContainer.style.display = show ? 'block' : 'none';
            if (show) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Handle message submission
        messageForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const userMessage = messageInput.value.trim();

            if (userMessage) {
                addMessage(userMessage, 'user');
                messageInput.value = '';
                messageInput.disabled = true;
                showTypingIndicator(true);

                try {
                    // Send message to Flask backend
                    const response = await fetch('/chat', { // Your Flask route
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: userMessage }),
                    });

                    if (!response.ok) {
                        let errorText = `Error: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorText = errorData.error || errorText;
                        } catch (e) {
                            errorText = response.statusText || errorText;
                        }
                        throw new Error(errorText);
                    }

                    const data = await response.json();
                    const botResponse = data.answer; // Adjust based on your Flask response

                    addMessage(botResponse, 'bot');

                } catch (error) {
                    console.error('Error sending message:', error);
                    addMessage(`Sorry, an error occurred: ${error.message}. Please try again.`, 'bot');
                } finally {
                    showTypingIndicator(false);
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }
        });

        // Initial focus on the input field
        messageInput.focus();
    </script>
</body>
</html>
